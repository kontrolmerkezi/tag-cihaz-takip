<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>TAG Cihaz Yönetim ve Takip Sistemi</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* Stil ve layout tag_cihaz_sistem.html dosyasından alınmıştır */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f9f9f9;
    color: #222;
    margin: 0;
    padding: 20px;
    font-size: 14px;
  }
  h1 { font-size: 22px; color: #b91c1c; text-align: center; margin-bottom: 10px; }
  h2 { font-size: 18px; color: #7f1d1d; margin-bottom: 10px; }
  .container { max-width: 1300px; margin: auto; }
  .top-section { display: flex; gap: 20px; margin-bottom: 20px; }
  .chart-box, .summary-box { flex: 1; border-radius: 12px; padding: 16px; display: flex; align-items: center; justify-content: center; flex-direction: column; }
  .chart-box canvas { height: 100% !important; aspect-ratio: 1; }
  .summary-table, table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; font-size: 13px; }
  .summary-table th, .summary-table td, th, td { border: 1px solid #ccc; padding: 6px 40px; text-align: center; }
  .summary-table th { background: #7f1d1d; color: white; }
  .forms, .section { margin-bottom: 20px; }
  .section { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
  .section:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.1); }
  input, select { width: 100%; padding: 6px; margin-top: 4px; border: 1px solid #ccc; border-radius: 6px; font-size: 13px; }
  button { margin-top: 10px; padding: 8px 14px; background-color: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; }
  button:hover { background-color: #b91c1c; }
  #logList { max-height: 150px; overflow-y: auto; padding-left: 20px; font-size: 12px; }
  .forms { display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between; margin-bottom: 20px; }
  .forms .section { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); flex: 1; min-width: 300px; box-sizing: border-box; transition: all 0.3s ease; }
  .forms .section:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.1); }
</style>
</head>
<body>
<div class="container">
  <h1>TAG Cihaz Yönetim ve Takip Sistemi</h1>
  <div class="top-section">
    <div class="chart-box">
      <canvas id="durumChart"></canvas>
    </div>
    <div class="summary-box">
      <h2>📄 Durum Özeti</h2>
      <table class="summary-table" id="durumOzetTablo">
        <thead>
          <tr><th>Durum</th><th>Adet</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div class="forms">
    <div class="section">
      <h2>📦 Sıfır TAG Cihaz Girişi</h2>
      <label>Etiket:</label><input id="yeniTagEtiket" type="text">
      <label>Durum:</label>
      <select id="yeniTagDurum">
        <option>SAĞLAM</option>
        <option>ARIZALI</option>
        <option>KAYIP</option>
      </select>
      <button onclick="sifirTagEkle()">Cihazı Kaydet</button>
    </div>
    <div class="section">
      <h2>👤 Personel TAG Atama</h2>
      <label>Yeni Etiket:</label><input id="yeniEtiket" type="text">
      <label>Yeni İsim:</label><input id="yeniIsim" type="text">
      <label>Eski Etiket (varsa):</label><input id="eskiEtiket" type="text">
      <label>Eski Durum Ne Oldu?</label>
      <select id="eskiDurum">
        <option value="">- Seçiniz -</option>
        <option>ARIZALI</option>
        <option>KAYIP</option>
      </select>
      <button onclick="personelAta()">Atamayı Tamamla</button>
    </div>
    <div class="section">
      <h2>🛠️ Cihaz Tamir</h2>
      <label>Etiket:</label><input id="tamirEtiket" type="text">
      <button onclick="cihaziTamirEt()">SAĞLAM Yap</button>
    </div>
    <div class="section">
      <h2>🚪 İşten Ayrılan Personel</h2>
      <label>Etiket:</label><input id="ayrilanEtiket" type="text">
      <label>Yeni Durum:</label>
      <select id="ayrilanDurum">
        <option>SAĞLAM</option>
        <option>ARIZALI</option>
        <option>KAYIP</option>
      </select>
      <button onclick="ayrilaniPasiflestir()">Pasifleştir</button>
    </div>
  </div>
  <div class="section">
    <h2>📋 Cihaz Listesi</h2>
    <input type="text" id="arama" placeholder="Etiket veya isim ara..." oninput="listele()">
    <button onclick="disaAktar()">CSV'ye Aktar</button>
    <table>
      <thead><tr><th>Etiket</th><th>İsim</th><th>Durum</th></tr></thead>
      <tbody id="liste"></tbody>
    </table>
  </div>
  <div class="section">
    <h2>🕓 İşlem Geçmişi (LOG)</h2>
    <ul id="logList"></ul>
  </div>
</div>
<script>
const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbxkGA5bXd9rcGmWH7YsHzTbD1qXOnhX9Aq9RFvIgV4u/dev";

let cihazlar = [];
let logGecmisi = [];

// Başlangıçta verileri çek
fetch(GOOGLE_SHEET_URL)
  .then(res => res.json())
  .then(data => {
    cihazlar = data;
    verileriKaydet();
    listele();
  })
  .catch(err => console.error("Google Sheets verisi alınamadı:", err));

// LocalStorage'a yaz
function verileriKaydet() {
  localStorage.setItem("cihazlar", JSON.stringify(cihazlar));
}

// LOG ekle
function logEkle(metin, geriAlFonksiyonu = null) {
  const log = document.getElementById("logList");
  const li = document.createElement("li");
  li.textContent = new Date().toLocaleString() + " - " + metin;
  if (geriAlFonksiyonu) {
    const geriBtn = document.createElement("button");
    geriBtn.textContent = "Geri Al";
    geriBtn.style.marginLeft = "10px";
    geriBtn.onclick = () => {
      geriAlFonksiyonu();
      verileriKaydet();
      listele();
      li.remove();
      alert("İşlem geri alındı.");
    };
    li.appendChild(geriBtn);
  }
  log.prepend(li);
  logGecmisi.push({ metin, geriAlFonksiyonu });
}

// Listeyi ekrana bas
function listele() {
  const tbody = document.getElementById("liste");
  const arama = document.getElementById("arama").value.toLowerCase();
  tbody.innerHTML = "";
  cihazlar
    .filter(c => c.etiket.toLowerCase().includes(arama) || c.isim.toLowerCase().includes(arama))
    .forEach(c => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${c.etiket}</td><td>${c.isim}</td><td>${c.durum}</td>`;
      tbody.appendChild(tr);
    });
}

// Yeni cihaz ekle
function sifirTagEkle() {
  const etiket = document.getElementById("yeniTagEtiket").value.trim();
  const durum = document.getElementById("yeniTagDurum").value;
  if (!etiket) return alert("Etiket giriniz.");
  if (cihazlar.some(c => c.etiket === etiket)) return alert("Bu etiket zaten mevcut!");
  const yeniCihaz = { etiket, isim: "KONTROL MERKEZİ", durum };
  cihazlar.push(yeniCihaz);
  verileriKaydet();
  listele();
  logEkle(`${etiket} etiketiyle yeni cihaz eklendi.`);
  fetch(GOOGLE_SHEET_URL, {
    method: "POST",
    body: JSON.stringify(yeniCihaz)
  });
}

// Personel atama
function personelAta() {
  const yeniEtiket = document.getElementById("yeniEtiket").value.trim();
  const yeniIsim = document.getElementById("yeniIsim").value.trim();
  const eskiEtiket = document.getElementById("eskiEtiket").value.trim();
  const eskiDurum = document.getElementById("eskiDurum").value;

  if (!yeniEtiket || !yeniIsim) return alert("Yeni etiket ve isim zorunludur.");

  if (eskiEtiket) {
    const eskiCihaz = cihazlar.find(c => c.etiket === eskiEtiket);
    if (eskiCihaz) {
      const oncekiDurum = eskiCihaz.durum;
      eskiCihaz.durum = eskiDurum || "KAYIP";
      eskiCihaz.isim = "KONTROL MERKEZİ";
      fetch(GOOGLE_SHEET_URL, {
        method: "POST",
        body: JSON.stringify(eskiCihaz)
      });
    }
  }

  let cihaz = cihazlar.find(c => c.etiket === yeniEtiket);
  if (cihaz) {
    cihaz.isim = yeniIsim;
    cihaz.durum = "AKTİF";
  } else {
    cihaz = { etiket: yeniEtiket, isim: yeniIsim, durum: "AKTİF" };
    cihazlar.push(cihaz);
  }

  verileriKaydet();
  listele();
  logEkle(`${yeniIsim} kişisine ${yeniEtiket} etiketi atandı.`);

  fetch(GOOGLE_SHEET_URL, {
    method: "POST",
    body: JSON.stringify(cihaz)
  });
}

// Cihaz tamiri
function cihaziTamirEt() {
  const etiket = document.getElementById("tamirEtiket").value.trim();
  const cihaz = cihazlar.find(c => c.etiket === etiket);
  if (!cihaz) return alert("Etiket bulunamadı.");
  const oncekiDurum = cihaz.durum;
  cihaz.durum = "SAĞLAM";
  cihaz.isim = "KONTROL MERKEZİ";
  verileriKaydet();
  listele();
  logEkle(`${etiket} etiketiyle cihaz SAĞLAM yapıldı.`);

  fetch(GOOGLE_SHEET_URL, {
    method: "POST",
    body: JSON.stringify(cihaz)
  });
}

// Personel pasifleştirme
function ayrilaniPasiflestir() {
  const etiket = document.getElementById("ayrilanEtiket").value.trim();
  const yeniDurum = document.getElementById("ayrilanDurum").value;
  const cihaz = cihazlar.find(c => c.etiket === etiket);
  if (!cihaz) return alert("Etiket bulunamadı.");
  cihaz.durum = yeniDurum;
  cihaz.isim = "KONTROL MERKEZİ";
  verileriKaydet();
  listele();
  logEkle(`${etiket} etiketiyle cihaz ${yeniDurum} yapıldı.`);

  fetch(GOOGLE_SHEET_URL, {
    method: "POST",
    body: JSON.stringify(cihaz)
  });
}

// CSV dışa aktar
function disaAktar() {
  let csv = "Etiket,İsim,Durum\n";
  cihazlar.forEach(c => {
    csv += `${c.etiket},${c.isim},${c.durum}\n`;
  });
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "tag_cihaz_listesi.csv";
  link.click();
}
</script>
</body>
</html>
