<!DOCTYPE html>

<html lang="tr">
<head>
<meta charset="utf-8"/>
<title>TAG Cihaz Yönetim ve Takip Sistemi</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* Stil ve layout tag_cihaz_sistem.html dosyasından alınmıştır */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f9f9f9;
    color: #222;
    margin: 0;
    padding: 20px;
    font-size: 14px;
  }
  h1 { font-size: 22px; color: #b91c1c; text-align: center; margin-bottom: 10px; }
  h2 { font-size: 18px; color: #7f1d1d; margin-bottom: 10px; }
  .container { max-width: 1300px; margin: auto; }
  .top-section { display: flex; gap: 20px; margin-bottom: 20px; }
  .chart-box, .summary-box { flex: 1; border-radius: 12px; padding: 16px; display: flex; align-items: center; justify-content: center; flex-direction: column; }
  .chart-box canvas { height: 100% !important; aspect-ratio: 1; }
  .summary-table, table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; font-size: 13px; }
  .summary-table th, .summary-table td, th, td { border: 1px solid #ccc; padding: 6px 40px; text-align: center; }
  .summary-table th { background: #7f1d1d; color: white; }
  .forms, .section { margin-bottom: 20px; }
  .section { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
  .section:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.1); }
  input, select { width: 100%; padding: 6px; margin-top: 4px; border: 1px solid #ccc; border-radius: 6px; font-size: 13px; }
  button { margin-top: 10px; padding: 8px 14px; background-color: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; }
  button:hover { background-color: #b91c1c; }
  #logList { max-height: 150px; overflow-y: auto; padding-left: 20px; font-size: 12px; }
  .forms { display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between; margin-bottom: 20px; }
  .forms .section { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); flex: 1; min-width: 300px; box-sizing: border-box; transition: all 0.3s ease; }
  .forms .section:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.1); }

.bilgiMesaji {
  color: green;
  margin-top: 10px;
  font-weight: bold;
}
</style>
</head>
<body>
<div class="container">
<h1>TAG Cihaz Yönetim ve Takip Sistemi</h1>
<div class="top-section">
<div class="chart-box">
<canvas id="durumChart"></canvas>
</div>
<div class="summary-box">
<h2>📄 Durum Özeti</h2>
<table class="summary-table" id="durumOzetTablo">
<thead>
<tr><th>Durum</th><th>Adet</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="forms">
<div class="section">
<h2>📦 Sıfır TAG Cihaz Girişi</h2>
<label>Etiket:</label><input id="yeniTagEtiket" type="text"/>
<label>Durum:</label>
<select id="yeniTagDurum">
<option>SAĞLAM</option>
<option>ARIZALI</option>
<option>KAYIP</option>
</select><div class="bilgiMesaji" id="sifirTagBilgi"></div>
<button onclick="sifirTagEkle()">Cihazı Kaydet</button>
</div>
<div class="section">
<h2>👤 Personel TAG Atama</h2>
<label>Yeni Etiket:</label><input id="yeniEtiket" type="text"/>
<label>Yeni İsim:</label><input id="yeniIsim" type="text"/>
<label>Eski Etiket (varsa):</label><input id="eskiEtiket" type="text"/>
<label>Eski Durum Ne Oldu?</label>
<select id="eskiDurum">
<option value="">- Seçiniz -</option>
<option>ARIZALI</option>
<option>KAYIP</option>
</select><div class="bilgiMesaji" id="personelBilgi"></div>
<button onclick="personelAta()">Atamayı Tamamla</button>
</div>
<div class="section">
<h2>🛠️ Cihaz Tamir</h2>
<label>Etiket:</label><input id="tamirEtiket" type="text"/><div class="bilgiMesaji" id="tamirBilgi"></div>
<button onclick="cihaziTamirEt()">SAĞLAM Yap</button>
</div>
<div class="section">
<h2>🚪 İşten Ayrılan Personel</h2>
<label>Etiket:</label><input id="ayrilanEtiket" type="text"/>
<label>Yeni Durum:</label>
<select id="ayrilanDurum">
<option>SAĞLAM</option>
<option>ARIZALI</option>
<option>KAYIP</option>
</select><div class="bilgiMesaji" id="ayrilanBilgi"></div>
<button onclick="ayrilaniPasiflestir()">Pasifleştir</button>
</div>
</div>
<div class="section">
<h2>📋 Cihaz Listesi</h2>
<input id="arama" oninput="listele()" placeholder="Etiket veya isim ara..." type="text"/>
<button onclick="disaAktar()">CSV'ye Aktar</button>
<table>
<thead><tr><th>Etiket</th><th>İsim</th><th>Durum</th></tr></thead>
<tbody id="liste"></tbody>
</table>
</div>
<div class="section">
<h2>🕓 İşlem Geçmişi (LOG)</h2>
<ul id="logList"></ul>
</div>
</div>
<script>
const GOOGLE_SHEET_GET = "https://opensheet.elk.sh/16W1kK3lAbGgKV5vrI90iYVp52ba5O1cTgT77ptYUilY/Sayfa1";
const GOOGLE_SHEET_POST = "https://script.google.com/macros/s/AKfycbxkGA5bXd9rcGmWH7YsHzTbD1qXOnhX9Aq9RFvIgV4u/dev";
let cihazlar = [];

fetch(GOOGLE_SHEET_GET)
  .then(res => res.json())
  .then(data => {
    cihazlar = data.map(c => ({
      etiket: c.etiket,
      isim: c.isim,
      soyisim: c.soyisim,
      durum: c.durum
    }));
    verileriKaydet();
    listele();
    ozetGuncelle();
    grafikCiz();
  })
  .catch(err => console.error("Google Sheets verisi alınamadı:", err));

function verileriKaydet() {
  localStorage.setItem("cihazlar", JSON.stringify(cihazlar));
}

function listele() {
  const tbody = document.getElementById("liste");
  const arama = document.getElementById("arama").value.toLowerCase();
  tbody.innerHTML = "";
  cihazlar
    .filter(c => (c.etiket && c.etiket.toLowerCase().includes(arama)) || 
                 ((c.isim + " " + c.soyisim).toLowerCase().includes(arama)))
    .forEach(c => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${c.etiket}</td><td>${c.isim} ${c.soyisim}</td><td>${c.durum}</td>`;
      tbody.appendChild(tr);
    });
}

function sifirTagEkle() {
  const etiket = document.getElementById("yeniTagEtiket").value.trim();
  const durum = document.getElementById("yeniTagDurum").value;
  if (!etiket) return alert("Etiket giriniz.");
  if (cihazlar.some(c => c.etiket === etiket)) return alert("Bu etiket zaten mevcut!");
  const yeniCihaz = { etiket, isim: "KONTROL", soyisim: "MERKEZİ", durum };
  cihazlar.push(yeniCihaz);
  verileriKaydet();
  listele();
  document.getElementById("yeniTagEtiket").value = "";
  document.getElementById("yeniTagDurum").value = "SAĞLAM";
  document.getElementById("sifirTagBilgi").textContent = "✅ Cihaz başarıyla kaydedildi.";

  ozetGuncelle();
  fetch(GOOGLE_SHEET_POST, {
    method: "POST",
    body: JSON.stringify(yeniCihaz)
  });
}

function personelAta() {
  const yeniEtiket = document.getElementById("yeniEtiket").value.trim();
  const isim = document.getElementById("yeniIsim").value.trim();
  const soyisim = document.getElementById("yeniSoyisim").value.trim();
  if (!yeniEtiket || !isim || !soyisim) return alert("Etiket, isim ve soyisim zorunludur.");

  let cihaz = cihazlar.find(c => c.etiket === yeniEtiket);
  if (cihaz) {
    cihaz.isim = isim;
    cihaz.soyisim = soyisim;
    cihaz.durum = "AKTİF";
  } else {
    cihaz = { etiket: yeniEtiket, isim, soyisim, durum: "AKTİF" };
    cihazlar.push(cihaz);
  }
  verileriKaydet();
  listele();
  document.getElementById("yeniEtiket").value = "";
  document.getElementById("yeniIsim").value = "";
  document.getElementById("yeniSoyisim").value = "";
  document.getElementById("eskiEtiket").value = "";
  document.getElementById("eskiDurum").value = "";
  document.getElementById("personelBilgi").textContent = "✅ Personelin cihazı değiştirildi.";

  ozetGuncelle();
  fetch(GOOGLE_SHEET_POST, {
    method: "POST",
    body: JSON.stringify(cihaz)
  });
}

function cihaziTamirEt() {
  const etiket = document.getElementById("tamirEtiket").value.trim();
  const cihaz = cihazlar.find(c => c.etiket === etiket);
  if (!cihaz) return alert("Etiket bulunamadı.");
  cihaz.durum = "SAĞLAM";
  cihaz.isim = "KONTROL";
  cihaz.soyisim = "MERKEZİ";
  verileriKaydet();
  listele();
  document.getElementById("tamirEtiket").value = "";
  document.getElementById("tamirBilgi").textContent = "✅ Cihaz tamir edildi.";

  ozetGuncelle();
  fetch(GOOGLE_SHEET_POST, {
    method: "POST",
    body: JSON.stringify(cihaz)
  });
}

function ayrilaniPasiflestir() {
  const etiket = document.getElementById("ayrilanEtiket").value.trim();
  const yeniDurum = document.getElementById("ayrilanDurum").value;
  const cihaz = cihazlar.find(c => c.etiket === etiket);
  if (!cihaz) return alert("Etiket bulunamadı.");
  cihaz.durum = yeniDurum;
  cihaz.isim = "KONTROL";
  cihaz.soyisim = "MERKEZİ";
  verileriKaydet();
  listele();
  document.getElementById("ayrilanEtiket").value = "";
  document.getElementById("ayrilanDurum").value = "SAĞLAM";
  let mesaj = "✅ Cihaz teslim alındı.";
  if (cihaz.durum === "ARIZALI") mesaj = "🔧 Cihaz arızalı teslim alındı.";
  else if (cihaz.durum === "SAĞLAM") mesaj = "✅ Cihaz sağlam teslim alındı.";
  document.getElementById("ayrilanBilgi").textContent = mesaj;

  ozetGuncelle();
  fetch(GOOGLE_SHEET_POST, {
    method: "POST",
    body: JSON.stringify(cihaz)
  });
}

function ozetGuncelle() {
  const ozet = document.getElementById("durumOzetTablo").querySelector("tbody");
  const sayim = {};
  cihazlar.forEach(c => {
    sayim[c.durum] = (sayim[c.durum] || 0) + 1;
  });
  ozet.innerHTML = "";
  for (const durum in sayim) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${durum}</td><td>${sayim[durum]}</td>`;
    ozet.appendChild(tr);
  }
}

function grafikCiz() {
  const ctx = document.getElementById('grafikCanvas');
  if (!ctx) return;
  const sayim = {};
  cihazlar.forEach(c => {
    sayim[c.durum] = (sayim[c.durum] || 0) + 1;
  });
  const labels = Object.keys(sayim);
  const data = Object.values(sayim);
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Cihaz Sayısı',
        data: data,
        backgroundColor: '#ef4444'
      }]
    }
  });
}
</script></body>
</html>
